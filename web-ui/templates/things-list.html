{% extends "base.html" %}

{% block title %}Things List - Digital Twin Platform{% endblock %}

{% block content %}
<div class="things-container">
    <!-- Things Header -->
    <section class="things-header">
        <div class="things-title">
            <h2>Digital Things</h2>
            <p class="things-subtitle">Manage all your digital twin things</p>
        </div>
        
        <div class="things-actions">
            <a href="/create-thing" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Create Thing
            </a>
            <button class="btn btn-secondary" id="bulk-actions-toggle" disabled>
                <i class="fas fa-tasks"></i>
                Bulk Actions
            </button>
        </div>
    </section>

    <!-- Search and Filter Bar -->
    <section class="filter-bar">
        <div class="filter-grid">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Search things by ID, manufacturer, model..." class="search-input">
                <button class="btn btn-icon search-clear" id="search-clear">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="filter-dropdown">
                <select id="manufacturer-filter" class="filter-select">
                    <option value="">All Manufacturers</option>
                </select>
            </div>
            
            <div class="filter-dropdown">
                <select id="model-filter" class="filter-select">
                    <option value="">All Models</option>
                </select>
            </div>
            
            <div class="filter-dropdown">
                <select id="status-filter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            
            <button class="btn btn-secondary" id="clear-filters">
                <i class="fas fa-filter"></i>
                Clear Filters
            </button>
        </div>
    </section>

    <!-- Bulk Actions Bar (Hidden by default) -->
    <section class="bulk-actions-bar" id="bulk-actions-bar" style="display: none;">
        <div class="bulk-actions-content">
            <span class="bulk-selection-count" id="bulk-selection-count">0 selected</span>
            <div class="bulk-actions-buttons">
                <button class="btn btn-warning" id="bulk-edit">
                    <i class="fas fa-edit"></i>
                    Edit Selected
                </button>
                <button class="btn btn-danger" id="bulk-delete">
                    <i class="fas fa-trash"></i>
                    Delete Selected
                </button>
                <button class="btn btn-secondary" id="bulk-cancel">
                    Cancel
                </button>
            </div>
        </div>
    </section>

    <!-- Things Table -->
    <section class="things-table-section">
        <div class="table-container">
            <div class="table-header">
                <div class="table-controls">
                    <div class="table-info">
                        <span id="things-count">0 things</span>
                        <span class="separator">|</span>
                        <span id="filtered-count">0 filtered</span>
                    </div>
                    
                    <div class="table-pagination" id="table-pagination">
                        <button class="btn btn-sm" id="prev-page" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="pagination-info" id="pagination-info">Page 1 of 1</span>
                        <button class="btn btn-sm" id="next-page" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="things-table" id="things-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">
                                <input type="checkbox" id="select-all" class="table-checkbox">
                            </th>
                            <th class="sortable" data-sort="thingId">
                                Thing ID
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="manufacturer">
                                Manufacturer
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="model">
                                Model
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th>Status</th>
                            <th class="sortable" data-sort="created">
                                Created
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="things-table-body">
                        <tr class="loading-row">
                            <td colspan="7" class="loading-cell">
                                <div class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Loading things...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Thing Detail Modal -->
<div class="modal" id="thing-detail-modal">
    <div class="modal-overlay" id="thing-detail-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="thing-detail-title">Thing Details</h3>
            <button class="btn btn-icon modal-close" id="thing-detail-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="thing-detail-tabs">
                <button class="tab-button active" data-tab="overview">Overview</button>
                <button class="tab-button" data-tab="attributes">Attributes</button>
                <button class="tab-button" data-tab="features">Features</button>
                <button class="tab-button" data-tab="json">Raw JSON</button>
            </div>
            
            <div class="tab-content active" id="tab-overview">
                <div class="thing-overview" id="thing-overview-content">
                    <!-- Overview content will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="tab-content" id="tab-attributes">
                <div class="thing-attributes" id="thing-attributes-content">
                    <!-- Attributes content will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="tab-content" id="tab-features">
                <div class="thing-features" id="thing-features-content">
                    <!-- Features content will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="tab-content" id="tab-json">
                <pre class="json-viewer" id="thing-json-content">
                    <!-- JSON content will be populated by JavaScript -->
                </pre>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn btn-primary" id="edit-thing-link">
                <i class="fas fa-edit"></i>
                Edit Thing
            </a>
            <button class="btn btn-secondary" id="thing-detail-close-footer">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-confirmation-modal">
    <div class="modal-overlay" id="delete-confirmation-overlay"></div>
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h3>Confirm Deletion</h3>
            <button class="btn btn-icon modal-close" id="delete-confirmation-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="confirmation-content">
                <i class="fas fa-exclamation-triangle warning-icon"></i>
                <p id="delete-confirmation-message">Are you sure you want to delete this thing?</p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="confirm-delete">
                <i class="fas fa-trash"></i>
                Delete
            </button>
            <button class="btn btn-secondary" id="cancel-delete">
                Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Things list specific JavaScript  
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Things list page loaded, loading things...');
        loadThingsForList();
    });
    
    async function loadThingsForList() {
        const tableBody = document.getElementById('things-table-body');
        if (!tableBody) {
            console.error('Table body not found');
            return;
        }
        
        try {
            // Show loading state
            tableBody.innerHTML = `
                <tr class="loading-row">
                    <td colspan="7" class="loading-cell">
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading things...
                        </div>
                    </td>
                </tr>
            `;
            
            console.log('Fetching things from API...');
            const response = await fetch('/mongodb/things');
            const data = await response.json();
            
            console.log('API response:', data);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const things = data.things || [];
            console.log(`Found ${things.length} things`);
            
            // Update counters
            const thingsCount = document.getElementById('things-count');
            const filteredCount = document.getElementById('filtered-count');
            if (thingsCount) thingsCount.textContent = `${things.length} things`;
            if (filteredCount) filteredCount.textContent = `${things.length} filtered`;
            
            if (things.length === 0) {
                tableBody.innerHTML = `
                    <tr class="no-data-row">
                        <td colspan="7" class="loading-cell">
                            <div class="empty-state">
                                <i class="fas fa-info-circle"></i>
                                No things found
                                <br>
                                <a href="/create-thing" class="btn btn-primary" style="margin-top: 10px;">
                                    <i class="fas fa-plus"></i> Create Your First Thing
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Render things in table
            const thingsHtml = things.map(thing => `
                <tr class="thing-row" data-thing-id="${thing.thingId}">
                    <td class="checkbox-column">
                        <input type="checkbox" class="thing-checkbox" value="${thing.thingId}">
                    </td>
                    <td class="thing-id-cell">
                        <strong>${thing.thingId}</strong>
                    </td>
                    <td>${thing.attributes?.manufacturer || '-'}</td>
                    <td>${thing.attributes?.model || '-'}</td>
                    <td>
                        <span class="status-badge status-${thing.status || 'unknown'}">
                            ${(thing.status || 'unknown').toUpperCase()}
                        </span>
                    </td>
                    <td>${thing._created ? new Date(thing._created).toLocaleDateString() : '-'}</td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <a href="/edit-thing/${thing.thingId}" class="btn btn-sm btn-secondary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline" onclick="viewThingDetails('${thing.thingId}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteThing('${thing.thingId}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            tableBody.innerHTML = thingsHtml;
            console.log('Things table populated successfully');
            
        } catch (error) {
            console.error('Failed to load things:', error);
            tableBody.innerHTML = `
                <tr class="error-row">
                    <td colspan="7" class="loading-cell">
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            Failed to load things: ${error.message}
                            <br>
                            <button class="btn btn-secondary" onclick="loadThingsForList()" style="margin-top: 10px;">
                                <i class="fas fa-retry"></i> Retry
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    // Helper functions for actions
    function viewThingDetails(thingId) {
        console.log('Viewing details for thing:', thingId);
        window.location.href = `/edit-thing/${thingId}`;
    }
    
    async function deleteThing(thingId) {
        if (confirm(`Are you sure you want to delete thing "${thingId}"?`)) {
            try {
                console.log('Deleting thing:', thingId);
                
                const response = await fetch(`/mongodb/things/${thingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log(`Thing "${thingId}" deleted successfully`);
                    // Show success message
                    alert(`Thing "${thingId}" has been deleted successfully!`);
                    // Reload the things list to reflect the changes
                    await loadThingsForList();
                } else if (response.status === 404) {
                    alert(`Thing "${thingId}" not found. It may have already been deleted.`);
                    // Reload the list anyway to refresh the view
                    await loadThingsForList();
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('Delete failed:', errorData);
                    alert(`Failed to delete thing "${thingId}": ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting thing:', error);
                alert(`Error deleting thing "${thingId}": ${error.message}`);
            }
        }
    }
</script>
{% endblock %}